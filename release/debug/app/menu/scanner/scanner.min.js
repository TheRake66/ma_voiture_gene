import Attribute from"../../../../.kernel/js/html/attribute.min.js";import Dom from"../../../../.kernel/js/html/dom.min.js";import Finder from"../../../../.kernel/js/html/finder.min.js";import Rest from"../../../../.kernel/js/communication/rest.min.js";import Cookie from"../../../../.kernel/js/io/cookie.min.js";import Location from"../../../../.kernel/js/url/location.min.js";import Modal from"../../../lib/js/modal.min.js";import Msgbox from"../../../lib/js/msgbox.min.js";export default class Scanner{scanner=Finder.tag("scanner")[0];video=Finder.query("video",this.scanner);canvas=Finder.query("canvas",this.scanner);width=500;height=500;streaming=!1;pocessing=!1;openned=!1;redirect=!1;constructor(){this.startStream(),this.mainLoop()}async mainLoop(){for(;;)!this.streaming||this.openned||this.pocessing?await new Promise((e=>setTimeout(e,10))):this.takePicture()}startStream(){window.navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,window.navigator.getMedia({video:{facingMode:"environment"},audio:!1},(e=>{this.video.srcObject=e,this.video.play()}),(e=>{Msgbox.show("Erreur","Impossible de lancer le stream",Msgbox.IMG_ERROR)})),this.video.addEventListener("canplay",(e=>{this.streaming||(this.height=this.video.videoHeight/(this.video.videoWidth/this.width),this.video.setAttribute("width",this.width),this.video.setAttribute("height",this.height),this.canvas.setAttribute("width",this.width),this.canvas.setAttribute("height",this.height),this.streaming=!0)}),!1)}takePicture(){this.pocessing=!0,this.canvas.getContext("2d").drawImage(this.video,0,0,this.width,this.height);let e=this.canvas.toDataURL("image/png");Rest.post("/api/plaques/ocr",((e,t)=>{e&&(menu_scanner.scanManually(),Finder.query("modal #add #numero").value=e),this.pocessing=!1}),(()=>{this.pocessing=!1}),(()=>{this.pocessing=!1}),(()=>{this.pocessing=!1}),{image:e},0,!0)}scanManually(){this.openned=!0,Modal.create("Ajouter",'\n            <label class="label">NUMERO DE PLAQUE</label>\n            <input type="text" id="numero" class="input" placeholder="AA-123-BB">\n        ',(()=>{let e=Finder.query("modal #add #numero").value.trim();""===e?Msgbox.show("Attention","Veuillez entrer un numéro de plaque",Msgbox.IMG_WARN):Rest.get(`/api/plaques/${e}`,((e,t)=>{if(e.id==Cookie.get("ma_voiture_gene_session_id"))return void Msgbox.show("Attention","Vous ne pouvez pas scanner votre propre véhicule",Msgbox.IMG_WARN);let s=()=>{if(menu_scanner.redirect)return;let t=()=>Msgbox.show("Erreur","Impossible de créer la conversation",Msgbox.IMG_ERROR);Rest.post("/api/conversations",((e,t)=>{Location.go(`/conversations?id=${e}`)}),t,t,t,{interlocuteur:e.id},0,!1)},i=()=>Msgbox.show("Erreur","Impossible de récupérer les conversations.",Msgbox.IMG_ERROR);Rest.getFor("/api/conversations/moi",((t,s)=>{let i=()=>Msgbox.show("Erreur","Impossible de récupérer les membres.",Msgbox.IMG_ERROR);Rest.getFor(`/api/conversations/${t._id}/membres`,((s,i)=>{s._id==e.id&&(menu_scanner.redirect=!0,Location.go(`/conversations?id=${t._id}`))}),null,null,i,i,i,null,0,!1)}),null,s,s,i,i,null,0,!1)}),(()=>{Msgbox.show("Introuvable","Cette plaque n'est associée à aucun de nos utilisateur.",Msgbox.IMG_ERROR)}),(()=>{Msgbox.show("Erreur","Impossible de récupérer les informations de cette plaque.",Msgbox.IMG_ERROR)}))}),(()=>{this.openned=!1,Modal.close()}),"add")}}
