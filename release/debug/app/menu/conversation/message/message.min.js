import Attribute from"../../../../../.kernel/js/html/attribute.min.js";import Dom from"../../../../../.kernel/js/html/dom.min.js";import Finder from"../../../../../.kernel/js/html/finder.min.js";import Rest from"../../../../../.kernel/js/communication/rest.min.js";import Location from"../../../../../.kernel/js/url/location.min.js";import Cookie from"../../../../../.kernel/js/io/cookie.min.js";import Msgbox from"../../../../lib/js/msgbox.min.js";import Builder from"../../../../../.kernel/js/html/builder.min.js";export default class Message{container=Finder.query("menu-conversation-message");name=Finder.query("menu-conversation-message #name");input=Finder.query("menu-conversation-message #input");send=Finder.query("menu-conversation-message #send");picture=Finder.query("menu-conversation-message #picture");section=Finder.query("menu-conversation-message #section");predefini=Finder.query("menu-conversation-message #predefini");conversation_id=null;my_id=Cookie.get("ma_voiture_gene_session_id");my=null;interlocutor_id=null;interlocutor_id=null;last_message_offset=0;bloquer=!1;last_date=new Date;constructor(){}loadPredefini(){Rest.getFor("/api/messages/exemples",((e,t)=>{Dom.append(Builder.create("button",{innerText:e.contenu,className:"button-circle",onclick:()=>{this.input.value=e.contenu}}),this.predefini)}),(()=>{}),(()=>{}),(()=>{}),(()=>{}),(()=>{}),{},0,!0)}toImg(e){return null===e?"/assets/img/default.png":"data:image/png;base64,"+e}scrollToLast(){let e=Finder.queryLast("div",this.section);e&&e.scrollIntoView()}loadMy(){Rest.get(`/api/utilisateurs/${this.my_id}`,((e,t)=>{this.my=e}),null,null,null,null,0,!1)}loadInterlocutor(){Rest.get(`/api/utilisateurs/${this.interlocutor_id}`,((e,t)=>{this.interlocutor=e}),null,null,null,null,0,!1)}addMessageMy(e){this.last_message_offset++,Dom.insert(`\n            <div class="right">\n                <article>\n                    <span>${e.contenu}</span>\n                    <i>${e.envoye_le}</i>  \n                    <div></div>\n                </article>\n                <img src="${this.toImg(this.my.photo)}" alt="PP">\n            </div>\n        `,this.section),this.scrollToLast()}addMessageInterlocutor(e){this.last_message_offset++,Dom.insert(`\n            <div class="left">\n                <img src="${this.toImg(this.interlocutor.photo)}" alt="PP">\n                <article>\n                    <div></div>\n                    <span>${e.contenu}</span>\n                    <i>${e.envoye_le}</i>  \n                </article>\n            </div>\n        `,this.section),this.scrollToLast(),menu_conversation_liste.refreshMessage()}checkBloque(){let e=!1,t="";Rest.get(`/api/utilisateurs/${this.interlocutor_id}/bloque`,((s,i)=>{s&&(e=!0,t="Vous avez bloqué cet utilisateur.")}),null,null,null,null,0,!1),e||Rest.get(`/api/utilisateurs/${this.interlocutor_id}/bloque/moi`,((s,i)=>{s&&(e=!0,t="Cet utilisateur vous a bloqué.")}),null,null,null,null,0,!1),e!==this.bloquer&&(e?(Attribute.disable(this.input),Attribute.disable(this.send),this.predefini.style.display="none",this.send.style.display="none",this.input.value=t):(Attribute.enable(this.input),Attribute.enable(this.send),this.predefini.style.display="flex",this.send.style.display="block",this.input.value=""),this.bloquer=e)}loadConversation(){Rest.getFor(`/api/conversations/${this.conversation_id}/membres`,((e,t)=>{this.interlocutor=e,this.interlocutor_id=e._id,this.picture.src=null===this.interlocutor.photo?"/assets/img/default.png":"data:image/png;base64,"+this.interlocutor.photo,this.name.innerText=this.interlocutor.prenom+" "+this.interlocutor.nom}),null,null,null,null,null,null,0,!1)}sendInput(){let e=this.input.value;if(""===e.trim())return;let t=()=>Msgbox.show("Erreur","Le message n'a pas pu être envoyé.",Msgbox.IMG_ERROR);Rest.post(`/api/conversations/${this.conversation_id}/messages`,((s,i)=>{if(s){let t={contenu:e,envoye_le:(new Date).toLocaleString()};this.addMessageMy(t),this.input.value="",menu_conversation_liste.refreshMessage()}else t()}),(()=>{t()}),(()=>{t()}),(()=>{t()}),{contenu:e},0,!1)}async mainLoop(){for(;;)null!==this.conversation_id&&this.refreshMessage(),await new Promise((e=>setTimeout(e,3e3)))}refreshMessage(){Rest.getFor(`/api/conversations/${this.conversation_id}/messages/${this.last_message_offset}`,((e,t)=>{let s=new Date(e.envoye_le);(null===this.last_date||this.last_date.getDay()!==s.getDay()&&this.last_date.getMonth()!==s.getMonth()&&this.last_date.getFullYear()!==s.getFullYear())&&(Dom.insert(`\n                        <span>${e.envoye_le}</span>\n                    `,this.section),this.last_date=s),e.id_Utilisateur==this.my_id?this.addMessageMy(e):this.addMessageInterlocutor(e)}),(()=>{}),(()=>{this.setAllSeen(),this.checkBloque()}),(()=>{this.setAllSeen(),this.checkBloque()}),(()=>{this.setAllSeen(),this.checkBloque()}),(()=>{}),{},0,!0)}setAllSeen(){window.onMobile&&!menu_conversation_liste.open||Rest.post(`/api/conversations/${this.conversation_id}/vu`)}changeConv(e){this.conversation_id=e,this.interlocutor_id=null,this.interlocutor=null,this.last_message_offset=0,Dom.clear(this.section),Attribute.enable(this.input),Attribute.enable(this.send),this.predefini.style.display="flex",this.loadConversation(),this.checkBloque(),this.refreshMessage()}deleteConv(){this.conversation_id=null,this.interlocutor_id=null,this.interlocutor=null,this.last_message_offset=0,Dom.clear(this.section),Attribute.disable(this.input),Attribute.disable(this.send),this.predefini.style.display="none",this.picture.src="/assets/img/default.png",this.name.innerText="",this.refreshMessage(),window.onMobile&&this.comeBack()}comeBack(){menu_conversation_liste.container.style.transform="translateX(0%)",menu_conversation_liste.open=!1}showInfo(){this.container.style.transform="translateX(-100%)"}}
