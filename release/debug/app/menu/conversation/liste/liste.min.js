import Attribute from"../../../../../.kernel/js/html/attribute.min.js";import Dom from"../../../../../.kernel/js/html/dom.min.js";import Finder from"../../../../../.kernel/js/html/finder.min.js";import Rest from"../../../../../.kernel/js/communication/rest.min.js";import Location from"../../../../../.kernel/js/url/location.min.js";import Cookie from"../../../../../.kernel/js/io/cookie.min.js";import Query from"../../../../../.kernel/js/url/query.min.js";export default class Liste{container=Finder.query("menu-conversation-liste");conversations=[];last_clicked_id=null;cleared=!1;open=!1;self_open=!1;my_id=Cookie.get("ma_voiture_gene_session_id");constructor(){}async mainLoop(){for(;;)this.refreshMessage(),await new Promise((e=>setTimeout(e,3e3)))}refreshMessage(){Rest.getFor("/api/conversations/moi",((e,n)=>{let t=null,i=null,s="",o="",l="",r="",a="";if(Rest.getFor(`/api/conversations/${e._id}/membres`,((e,n)=>{t=e}),null,null,null,null,null,null,0,!1),r=null===t.photo?"/assets/img/default.png":"data:image/png;base64,"+t.photo,a=t.prenom+" "+t.nom,Rest.get(`/api/conversations/${e._id}/messages/last`,((e,n)=>{i=e}),(()=>{}),(()=>{}),(()=>{}),{},0,!1),null!==i){let e=new Date(i.envoye_le),n=new Date;if(n.getFullYear()===e.getFullYear()&&n.getMonth()===e.getMonth()&&n.getDate()===e.getDate()){let n=e.getHours()<10?"0"+e.getHours():e.getHours(),t=e.getMinutes()<10?"0"+e.getMinutes():e.getMinutes();o+=n+":"+t}else o+=e.getDate()+" "+e.toLocaleString("default",{month:"long"});i.id_Utilisateur==this.my_id?(Rest.get(`/api/messages/${i._id}/vu/${t._id}`,((e,n)=>{s='<img src="/assets/img/icons8-double-coche-30.png" alt="Vu"/>'}),null,null,null,null,0,!1),l="Vous : "+i.contenu):Rest.get(`/api/messages/${i._id}/vu/${this.my_id}`,((e,n)=>{l=i.contenu}),(()=>{l=`<b>${i.contenu} </b>`,o=`<b>• ${o}</b>`}),null,null,null,0,!1)}else l=`<i>Dites bonjour à ${t.prenom} !</i>`;let c=this.conversations[e._id];if(c)Dom.replace(`\n                        <img src="${r}" alt="PP" />\n                        <article>\n                            <b>${a}</b>\n                            <p>${l}</p>\n                        </article>\n                        <div>\n                            <i>${o}</i>\n                            ${s}\n                        </div>\n                    `,c);else{Dom.insert(`\n                        <div class="conv_div" onclick="menu_conversation_liste.changeConv(${e._id})">\n                            <img src="${r}" alt="PP" />\n                            <article>\n                                <b>${a}</b>\n                                <p>${l}</p>\n                            </article>\n                            <div>\n                                <i>${o}</i>\n                                ${s}\n                            </div>\n                        </div>\n                    `,this.container);let n=Finder.queryLast(".conv_div",this.container);this.conversations[e._id]=n,this.self_open||Query.get("id")!=e._id?1!==Object.keys(this.conversations).length||window.onMobile||this.changeConv(e._id):(this.changeConv(e._id),this.self_open=!0)}}),(()=>{this.cleared||(Dom.clear(this.container),this.cleared=!0)}),(()=>{}),(()=>{Dom.clear(this.container),Dom.insert("<span>Aucune conversation</span>",this.container),this.cleared=!1}),(()=>{Dom.clear(this.container),Dom.insert("<span>Impossible de charger la liste des conversations</span>",this.container),this.cleared=!1}),(()=>{Dom.clear(this.container),Dom.insert("<span>La liste des conversations a expiré</span>",this.container),this.cleared=!1}),{},0,!0)}changeConv(e){window.onMobile&&(this.container.style.transform="translateX(-100%)",this.open=!0),this.last_clicked_id!==e&&(menu_conversation_message.changeConv(e),menu_conversation_info.changeConv(e)),this.last_clicked_id=e}deleteConv(){this.conversations[this.last_clicked_id].remove(),delete this.conversations[this.last_clicked_id],this.last_clicked_id=null,this.refreshMessage()}}
